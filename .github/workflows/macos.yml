name: macos-arm64

on:
  workflow_dispatch:

jobs:
  build-arm-macos-xcode:
    runs-on: macos-14
    steps:
      - name: Clone Minetest from Codeberg
        run: |
          git clone --depth 1 https://codeberg.org/halon/Minetest.git minetest

      - name: Clone mcl_localplayer mod
        working-directory: minetest
        run: |
          git clone --depth 1 https://codeberg.org/halon/mcl_localplayer.git clientmods/mcl_localplayer
          echo "load_mod_mcl_localplayer = true" > clientmods/mods.conf    
      
      - name: Work around GH macOS image's pinned CMake
        working-directory: minetest
        run: |
          set -euo pipefail
          if brew list --formula cmake >/dev/null 2>&1; then
            if brew info cmake | grep -q 'local/pinned'; then
              brew uninstall --force cmake
            fi
          fi

      - name: Install Dependencies
        shell: bash
        run: |
          set -euo pipefail
          pkgs=( gettext freetype gmp jpeg-turbo leveldb libogg libpng libvorbis luajit zstd sdl2 )
          export HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
          export HOMEBREW_NO_INSTALL_CLEANUP=1
          brew update --auto-update
          brew install --display-times "${pkgs[@]}"
          if brew ls --formula >/dev/null 2>&1; then
            brew unlink $(brew ls --formula) || true
          fi
          for f in "${pkgs[@]}"; do
            brew link --overwrite --force "$f" || true
          done

      - name: Append clientmods copy to Xcode resources
        working-directory: minetest
        run: |
          cat >> util/xcode/install_resources.cmake <<'CMAKE_SNIPPET'
          execute_process(
          	COMMAND ${CMAKE_COMMAND} -E copy_directory
          	"$ENV{SOURCE_ROOT}/clientmods"
          	"${RESOURCES_DIR}/clientmods"
          )
          CMAKE_SNIPPET

      - name: Build and Archive with Xcode
        run: |
          mkdir build_xcode
          cd build_xcode
          ../util/ci/build_xcode.sh
          
      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-${{ github.run_id }}
          path: minetest/build_xcode/build/Release/luanti.app
          if-no-files-found: error 